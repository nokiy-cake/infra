apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: greptimedb-standalone
  namespace: telemetry
spec:
  interval: 5m
  chart:
    spec:
      chart: greptimedb-standalone
      version: "0.2.12"
      sourceRef:
        kind: HelmRepository
        name: greptime
        namespace: flux-system
  values:
    persistence:
      size: 5Gi
      storageClass: sata
  install:
    crds: CreateReplace
  upgrade:
    crds: CreateReplace
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: grafana
  namespace: telemetry
spec:
  interval: 5m
  chart:
    spec:
      chart: grafana
      version: "9.4.5"
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
  values:
    annotations:
      operator.1password.io/item-path: "vaults/cake.nokiy.net/items/grafana"
      operator.1password.io/item-name: "grafana"
      operator.1password.io/auto-restart: "true"
    admin:
      existingSecret: grafana
      userKey: username
      passwordKey: password
    image:
      repository: grafana/grafana
      tag: 12.1.1
    extraInitContainers:
      - name: install-greptimedb-plugin
        image: grafana/grafana:12.1.1  # 使用与主容器相同的镜像
        command: ["sh", "-c"]
        args:
          - >
            grafana cli --pluginUrl https://github.com/GreptimeTeam/greptimedb-grafana-datasource/releases/latest/download/info8fcc-greptimedb-datasource.zip plugins install info8fcc-greptimedb-datasource
        volumeMounts:
          - name: grafana-greptimedb-plugin-storage
            mountPath: /var/lib/grafana/info8fcc-greptimedb-datasource
    extraVolumeMounts:
      - name: grafana-greptimedb-plugin-storage
        mountPath: /var/lib/grafana/info8fcc-greptimedb-datasource
    extraVolumes:
      - name: grafana-greptimedb-plugin-storage
        emptyDir: {}
